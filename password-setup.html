<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剧DuoDuo 密码设置</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }
        .container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ddd;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.secondary {
            background: #2196F3;
        }
        .button.secondary:hover {
            background: #1976D2;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background: #1b5e20;
            border: 1px solid #4CAF50;
            display: block;
        }
        .result.error {
            background: #b71c1c;
            border: 1px solid #f44336;
            display: block;
        }
        .code {
            background: #333;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            margin: 10px 0;
        }
        .info {
            background: #0d47a1;
            border: 1px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            text-align: center;
        }
        .tab.active {
            background: #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 剧DuoDuo 密码设置</h1>
            <p>设置您的自定义密码</p>
        </div>

        <div class="info">
            <p><strong>📝 当前默认密码：</strong> <code>admin123</code></p>
            <p>首次使用请用默认密码登录，然后在此页面设置新密码。</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('plaintext')">明文密码</div>
            <div class="tab" onclick="showTab('hash')">哈希值</div>
        </div>

        <!-- 明文密码设置 -->
        <div id="plaintext-tab" class="tab-content active">
            <div class="form-group">
                <label for="currentPassword">当前密码：</label>
                <input type="password" id="currentPassword" placeholder="输入当前密码 (默认: admin123)" value="admin123">
            </div>
            <div class="form-group">
                <label for="newPassword">新密码：</label>
                <input type="password" id="newPassword" placeholder="输入您的新密码">
            </div>
            <div class="form-group">
                <label for="confirmPassword">确认密码：</label>
                <input type="password" id="confirmPassword" placeholder="再次输入新密码">
            </div>
            <button class="button" onclick="updatePasswordLive()">立即更新密码</button>
        </div>

        <!-- 哈希值设置 -->
        <div id="hash-tab" class="tab-content">
            <div class="form-group">
                <label for="passwordHash">密码哈希值（SHA-256）：</label>
                <input type="text" id="passwordHash" placeholder="输入 SHA-256 哈希值">
            </div>
            <div class="form-group">
                <label for="plaintextForHash">对应的明文密码（用于验证）：</label>
                <input type="password" id="plaintextForHash" placeholder="输入明文密码以验证哈希">
            </div>
            <button class="button secondary" onclick="verifyAndSetHash()">验证并设置</button>
        </div>

        <button class="button secondary" onclick="generateFiles()">生成配置文件</button>

        <div id="result" class="result">
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // SHA-256 哈希计算
        async function calculateSHA256(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // 显示结果
        function showResult(content, isSuccess = true) {
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = content;
            result.className = 'result ' + (isSuccess ? 'success' : 'error');
        }

        // 实时更新密码
        async function updatePasswordLive() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword) {
                showResult('❌ 请输入当前密码', false);
                return;
            }

            if (!newPassword) {
                showResult('❌ 请输入新密码', false);
                return;
            }

            if (newPassword !== confirmPassword) {
                showResult('❌ 两次输入的密码不一致', false);
                return;
            }

            if (newPassword.length < 6) {
                showResult('❌ 密码长度至少6位', false);
                return;
            }

            try {
                showResult('🔄 正在更新密码...', true);

                // 调用API更新密码
                const response = await fetch('/api/update-password.mjs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update',
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showResult(`✅ 密码更新成功！
                        <div class="code">
旧密码: ${result.oldPassword}
新密码: ${result.newPassword}
新哈希: ${result.newHash}
                        </div>
                        <p><strong>📋 更新的文件:</strong></p>
                        <ul>
                            ${result.updatedFiles.map(file => 
                                `<li>${file.file}: ${file.updated ? '✅ 已更新' : '⏭️ ' + file.reason}</li>`
                            ).join('')}
                        </ul>
                        <p><strong>🎉 密码已实时更新，请刷新页面使用新密码登录！</strong></p>`, true);
                } else {
                    showResult(`❌ 更新失败: ${result.error}`, false);
                }
            } catch (error) {
                showResult(`❌ 更新失败: ${error.message}`, false);
            }
        }

        // 从明文密码设置（保留原有功能）
        async function setPasswordFromPlaintext() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword) {
                showResult('❌ 请输入新密码', false);
                return;
            }

            if (newPassword !== confirmPassword) {
                showResult('❌ 两次输入的密码不一致', false);
                return;
            }

            if (newPassword.length < 6) {
                showResult('❌ 密码长度至少6位', false);
                return;
            }

            try {
                const hash = await calculateSHA256(newPassword);
                await generateConfigFiles(newPassword, hash);
                showResult(`✅ 密码设置成功！<div class="code">新密码: ${newPassword}\n哈希值: ${hash}</div>`, true);
            } catch (error) {
                showResult(`❌ 设置失败: ${error.message}`, false);
            }
        }

        // 验证并设置哈希
        async function verifyAndSetHash() {
            const hash = document.getElementById('passwordHash').value.trim();
            const plaintext = document.getElementById('plaintextForHash').value;

            if (!hash) {
                showResult('❌ 请输入哈希值', false);
                return;
            }

            if (!/^[a-f0-9]{64}$/i.test(hash)) {
                showResult('❌ 无效的 SHA-256 哈希格式', false);
                return;
            }

            if (plaintext) {
                try {
                    const calculatedHash = await calculateSHA256(plaintext);
                    if (calculatedHash.toLowerCase() !== hash.toLowerCase()) {
                        showResult('❌ 明文密码与哈希值不匹配', false);
                        return;
                    }
                } catch (error) {
                    showResult(`❌ 哈希验证失败: ${error.message}`, false);
                    return;
                }
            }

            try {
                await generateConfigFiles(plaintext || '[从哈希设置]', hash.toLowerCase());
                showResult(`✅ 哈希设置成功！<div class="code">哈希值: ${hash.toLowerCase()}</div>`, true);
            } catch (error) {
                showResult(`❌ 设置失败: ${error.message}`, false);
            }
        }

        // 生成配置文件
        async function generateConfigFiles(password, hash) {
            const files = [
                {
                    name: 'config/master-config.js',
                    content: generateMasterConfig(password)
                },
                {
                    name: 'password-sync.js',
                    content: generateSyncScript(password)
                }
            ];

            let resultHTML = '<p><strong>🎉 配置文件生成完成！</strong></p>';
            files.forEach(file => {
                resultHTML += `<p><strong>${file.name}:</strong></p><div class="code">${file.content}</div>`;
            });
            
            showResult(resultHTML, true);
        }

        // 生成主配置文件内容
        function generateMasterConfig(password) {
            return `// 主配置文件 - 所有密码和核心配置的唯一来源
// 只需要在这里修改，其他文件会自动同步

const MASTER_CONFIG = {
    // 🔐 核心认证配置（只需要在这里修改）
    auth: {
        username: 'admin',                    // 用户名
        password: '${password}',            // 主密码（已自定义）
        enabled: true,                        // 是否启用密码保护
        sessionDuration: 90 * 24 * 60 * 60 * 1000,  // 90天
        maxLoginAttempts: 5,                  // 最大尝试次数
        lockoutDuration: 30 * 60 * 1000       // 锁定时间30分钟
    },
    
    // 其他配置保持不变...
};`;
        }

        // 生成同步脚本内容
        function generateSyncScript(password) {
            return `// 密码同步脚本 - 自动更新所有文件中的默认密码
// 使用方法: node password-sync.js

const fs = require('fs');
const path = require('path');

const NEW_PASSWORD = '${password}';
const OLD_PASSWORD = 'admin123';

const filesToUpdate = [
    'js/auth-config.js',
    'config/config-loader.mjs', 
    'functions/proxy/[[path]].js'
];

console.log('🔄 开始同步密码...');

filesToUpdate.forEach(filePath => {
    try {
        const fullPath = path.join(__dirname, filePath);
        if (fs.existsSync(fullPath)) {
            let content = fs.readFileSync(fullPath, 'utf8');
            content = content.replace(new RegExp(OLD_PASSWORD, 'g'), NEW_PASSWORD);
            fs.writeFileSync(fullPath, content, 'utf8');
            console.log('✅ 已更新:', filePath);
        }
    } catch (error) {
        console.error('❌ 更新失败:', filePath, error.message);
    }
});

console.log('🎉 密码同步完成！');`;
        }

        // 直接生成文件按钮
        function generateFiles() {
            const password = document.getElementById('newPassword').value || 
                           document.getElementById('plaintextForHash').value || 
                           'admin123';
            generateConfigFiles(password, '');
        }
    </script>
</body>

</html>
